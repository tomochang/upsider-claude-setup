# Claude Code ルール

## 開発ワークフロー — 最上位ルール

### Plan管理ルール

**Planは作業中プロジェクトのdocsフォルダに格納し、永続化する。**

### Plan ファイル命名規則

**形式:** `<descriptive-name>.<status>.md`

| サフィックス | 意味                     |
| ------------ | ------------------------ |
| (なし)       | 保存直後、未トリアージ   |
| `.wip`       | 作業中（計画中・実装中） |
| `.done`      | 完了                     |
| `.dropped`   | 中止・破棄               |

- Plan保存時はサフィックスなしでOK。作業開始時に `.wip` を付ける
- 完了したら `git mv` で `.wip` → `.done` にリネーム
- 中止したら `git mv` で `.wip` → `.dropped` にリネーム（理由をドキュメント冒頭に追記）

#### Planモード終了 → 実装開始時

Planモードで作成されたファイルは `~/.claude/plans/` に一時保存される。
**実装の最初のステップとして**、以下を実行する：

1. **プランファイルを適切なフォルダへコピー＆リネーム**
   - プロジェクト固有の場合 → `projects/<name>/docs/plans/<descriptive-name>.wip.md`
   - 汎用の場合 → `docs/plans/<descriptive-name>.wip.md`
   - プロジェクト固有かつ汎用参照価値がある場合 → 両方にコピー

2. **git commit & push**

3. **タスクを依存関係で分類** — プラン内の各ステップを「並列可能」「直列必須」に分ける
4. **並列可能タスクは1メッセージで同時実行** — 詳細は `.claude/rules/parallel-execution.md` 参照
5. **その後、実装に着手**（プランファイルの保存が完了するまでコードを書かない）

#### 実装開始時

1. **まず `docs/plans/` を探索**して関連するPlanがあるか確認
2. 関連Planがあれば読んで、その方針に従う
3. 関連Planがなければ新規にPlanモードで作成

### フェーズと順序

```
┌─────────────────────────────────────────────────┐
│ 1. プラン作成時 → ユーザー視点整理              │
│    （誰が、何を達成したいか、何がペインか）     │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 2. 実装開始時 → テストを先に書く（TDD）         │
│    （失敗するテストを書いてから実装）           │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 3. 実装 → テストを通すコードを書く              │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 4. 完了 → コミット＆プッシュ（＆デプロイ）      │
└─────────────────────────────────────────────────┘
```

---

## 1. ユーザー視点整理（プラン作成時）

**プランを作る前に、ユーザー視点で整理する。**

| 項目           | 質問                                 |
| -------------- | ------------------------------------ |
| **ユーザー**   | 誰が使うのか？（役職、スキル、状況） |
| **ゴール**     | そのユーザーは何を達成したいのか？   |
| **ペイン**     | 今、何が嫌・面倒・不便なのか？       |
| **アプローチ** | どう解決するか？                     |

これを整理してからプランを書く。プランにはこの整理結果を含める。

---

## 2. TDD（実装開始時）

**実装を始める時、コードより先にテストを書く。**

### 実装フロー

```
1. テストを先に書く（失敗するテスト）
   ↓
2. コードを実装
   ↓
3. テスト実行 → パス確認
   ↓
4. 自動でコミット＆プッシュ（＆デプロイ）
```

### 適用条件

| 変更種別                | テスト必須                        |
| ----------------------- | --------------------------------- |
| 新規機能/コンポーネント | 必須                              |
| 既存機能の修正          | 必須（修正箇所のテスト追加）      |
| バグ修正                | 必須（再発防止テスト）            |
| スタイルのみの変更      | 不要                              |
| ドキュメントのみ        | 不要                              |
| リファクタリング        | 既存テストがパスすることを確認    |

### テストがパスしたら自動実行

```bash
# テストパス後、ユーザーに確認せず自動で実行
git add -A && git commit -m "<変更内容>" && git push
# デプロイが必要なプロジェクトはデプロイも実行
```

---

## ワークスペースのファイルを編集する場合

ワークスペース配下のファイルを編集した場合、**即座に** commit & push すること。編集とcommit & pushは1セットで行う。後回しにしない。

---

## 手順メモリ (Procedural Memory)

`procedures/INDEX.md` に再利用可能な操作手順のインデックスがある。UserPromptSubmit hookが自動でマッチングし、`[PROCEDURE_MATCH]` でサジェストする。詳細は `procedures/CLAUDE.md` を参照。

---

## 失敗ログ（繰り返し防止）

Claudeが失敗したパターンを記録。同じ失敗を繰り返さない。

| 日付 | 失敗内容 | 原因 | 対策 |
| ---- | -------- | ---- | ---- |
| (例) | Plan保存忘れ | hookなし | check_unsaved_plans.sh hookを追加 |
| (例) | 返信案作成後、後続処理を実行せず放置 | ルールを読んでいなかった | 返信案作成後チェックリストを追加 |
| (例) | カレンダー未確認で返信案作成 | カレンダーツール未使用 | /schedule-reply コマンド作成 |
| (例) | メール検索で片方のアカウントしか見ず | 個人アカウントだけ検索した | メール検索ルールを追加 |
| (例) | MCPツール使えない→「できません」と報告 | トークン期限切れを「プロトコル制約」と誤認 | MCPフォールバックルール追加 |
